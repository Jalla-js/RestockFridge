<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes, maximum-scale=5" />
  <meta name="color-scheme" content="dark">
  <title>Trilogy (Cube) • Close Checklist</title>

  <style>
    :root{
      --bg: #070A10;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --stroke: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.5);
      --good: #28d17c;
      --warn: #ffcc66;
      --bad:  #ff5a67;
      --accent:#7C5CFF;
      --accent2:#23D5FF;

      --radius: 16px;
      --radius2: 12px;
      --gap: 14px;
      --gap2: 10px;
      --shadow: 0 12px 40px rgba(0,0,0,0.45);
      --shadow2: 0 10px 24px rgba(0,0,0,0.35);
    }

    *{ box-sizing: border-box; }
    html, body{
      height: 100%;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(124,92,255,0.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(35,213,255,0.12), transparent 50%),
                  radial-gradient(1000px 800px at 40% 110%, rgba(40,209,124,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Allow pinch zoom but discourage accidental double tap behaviour */
    body{
      overscroll-behavior-y: none;
    }

    a{ color: inherit; }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 16px 22px;
      padding-top: calc(18px + env(safe-area-inset-top));
      padding-bottom: calc(22px + env(safe-area-inset-bottom));
    }

    header{
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .title{
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title h1{
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.2px;
      font-weight: 700;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      box-shadow: var(--shadow2);
    }

    .btnrow{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    button, select{
      appearance: none;
      -webkit-appearance: none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 650;
      letter-spacing: 0.2px;
      box-shadow: var(--shadow2);
    }

    button{
      cursor: pointer;
      touch-action: manipulation; /* reduces accidental zoom on supported browsers */
    }

    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(124,92,255,0.45);
      background: linear-gradient(135deg, rgba(124,92,255,0.24), rgba(35,213,255,0.14));
    }
    button.ghost{
      background: rgba(255,255,255,0.04);
    }

    select{
      padding-right: 34px;
      position: relative;
    }

    .grid{
      display: grid;
      grid-template-columns: 1.35fr 0.9fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow: hidden;
    }

    .cardhead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .cardhead h2{
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .cardhead .hint{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 50%;
      text-align: right;
    }

    .cardbody{
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .tabs{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab{
      font-size: 12px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(124,92,255,0.45);
      background: linear-gradient(135deg, rgba(124,92,255,0.22), rgba(35,213,255,0.12));
    }

    .navrow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
    }

    .navrow .left, .navrow .right{
      display: flex; gap: 10px; align-items: center;
    }

    .table{
      display: grid;
      gap: 10px;
    }

    .row{
      display: grid;
      grid-template-columns: 1fr 80px 110px;
      gap: 10px;
      align-items: center;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.16);
      border-radius: var(--radius2);
    }

    .row .name{
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .row .name .label{
      font-weight: 700;
      font-size: 13px;
    }
    .row .name .meta{
      color: var(--muted2);
      font-size: 11px;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      width: 80px;
      text-align: center;
    }

    /* iOS-friendly numeric input:
       - type="tel" + inputmode numeric tends to keep keypad stable
       - avoid rerendering DOM while typing (we do)
    */
    input.qty{
      width: 110px;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline: none;
    }
    input.qty:focus{
      border-color: rgba(35,213,255,0.45);
      box-shadow: 0 0 0 3px rgba(35,213,255,0.14);
    }

    .split{
      display: grid;
      gap: 12px;
    }

    .sectiontitle{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }
    .sectiontitle .small{
      font-size: 12px;
      color: var(--muted);
    }

    .list{
      display: grid;
      gap: 10px;
    }

    label.check{
      display: grid;
      grid-template-columns: 20px 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.16);
      border-radius: var(--radius2);
    }

    input[type="checkbox"]{
      width: 18px;
      height: 18px;
      accent-color: var(--accent2);
    }

    .count{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 8px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      border-radius: 999px;
      min-width: 50px;
      text-align: center;
    }

    .danger{
      color: var(--bad);
      border-color: rgba(255,90,103,0.35);
    }

    .footerbtns{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      padding-top: 4px;
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }
    .modal.open{ display: flex; }
    .modalcard{
      width: min(900px, 100%);
      max-height: min(86vh, 900px);
      overflow: auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(10,12,18,0.92);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .modalhead{
      position: sticky;
      top: 0;
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(10,12,18,0.92);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modalhead h3{
      margin: 0;
      font-size: 14px;
    }
    textarea{
      width: 100%;
      min-height: 320px;
      resize: vertical;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
    }
    textarea:focus{
      border-color: rgba(124,92,255,0.45);
      box-shadow: 0 0 0 3px rgba(124,92,255,0.14);
    }
    .modalbody{
      padding: 14px;
      display: grid;
      gap: 12px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1 id="appTitle">Close Checklist</h1>
      <div class="sub">
        <span class="pill" id="venuePill">Venue: —</span>
        <span class="pill" id="barPill">Bar: —</span>
        <span class="pill" id="progressPill">Pick list: 0 items</span>
      </div>
    </div>

    <div class="btnrow">
      <select id="barSelect" aria-label="Select bar"></select>
      <button class="ghost" id="btnResetInputs" type="button">Reset counts</button>
      <button class="ghost" id="btnResetChecks" type="button">Reset checklists</button>
      <button class="primary" id="btnEditSetup" type="button">Edit setup</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: FRIDGES -->
    <section class="card" aria-label="Fridge restock">
      <div class="cardhead">
        <h2 id="fridgeTitle">Fridge</h2>
        <div class="hint" id="fridgeHint">—</div>
      </div>

      <div class="cardbody">
        <div class="tabs" id="fridgeTabs"></div>

        <div class="navrow">
          <div class="left">
            <button class="ghost" id="btnPrev" type="button">← Prev</button>
            <button class="ghost" id="btnNext" type="button">Next →</button>
          </div>
          <div class="right">
            <span class="muted" id="fridgeCounter">—</span>
          </div>
        </div>

        <div class="table" id="fridgeTable"></div>

        <div class="muted">
          Tip: type how many are <b>missing</b>. Your pick list on the right updates as you go.
        </div>
      </div>
    </section>

    <!-- RIGHT: PICK LIST + CLEAN DOWN (always visible) -->
    <aside class="split">
      <section class="card" aria-label="Pick list">
        <div class="cardhead">
          <h2>Pick list (what to get)</h2>
          <div class="hint" id="pickHint">Auto totals</div>
        </div>
        <div class="cardbody">
          <div class="sectiontitle">
            <div class="small">Tick off as you collect stock</div>
            <div class="small" id="pickTotals">—</div>
          </div>
          <div class="list" id="pickList"></div>

          <div class="footerbtns">
            <button class="ghost" id="btnCheckAllPick" type="button">Check all</button>
            <button class="ghost" id="btnUncheckAllPick" type="button">Uncheck all</button>
          </div>

          <div class="muted">
            This totals across all fridges for the selected bar.
          </div>
        </div>
      </section>

      <section class="card" aria-label="Clean down">
        <div class="cardhead">
          <h2>Clean down (Barcadia)</h2>
          <div class="hint" id="cleanHint">Checklist</div>
        </div>
        <div class="cardbody">
          <div class="sectiontitle">
            <div class="small">Do these before you finish</div>
            <div class="small" id="cleanTotals">—</div>
          </div>
          <div class="list" id="cleanList"></div>

          <div class="footerbtns">
            <button class="ghost" id="btnCheckAllClean" type="button">Check all</button>
            <button class="ghost" id="btnUncheckAllClean" type="button">Uncheck all</button>
          </div>

          <div class="muted">
            You can add other bars/rooms later in <b>Edit setup</b>.
          </div>
        </div>
      </section>
    </aside>
  </div>
</div>

<!-- SETUP MODAL -->
<div class="modal" id="setupModal" role="dialog" aria-modal="true" aria-label="Edit setup">
  <div class="modalcard">
    <div class="modalhead">
      <h3>Edit setup JSON</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
        <button class="ghost" id="btnLoadDefault" type="button">Load default</button>
        <button class="ghost" id="btnCancelSetup" type="button">Cancel</button>
        <button class="primary" id="btnSaveSetup" type="button">Save</button>
      </div>
    </div>
    <div class="modalbody">
      <div class="muted">
        Keep it valid JSON. This is stored on your phone (localStorage).
      </div>
      <textarea id="setupTextarea" spellcheck="false"></textarea>
      <div class="muted" id="setupError" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
/** ---------------------------
 *  Default setup (your Barcadia config)
 *  -------------------------- */
const DEFAULT_SETUP = {
  "venue": "Trilogy (Cube)",
  "bars": [
    {
      "id": "barcadia",
      "name": "Barcadia",
      "fridges": [
        {
          "id": "fridgeA",
          "name": "Fridge A (Top)",
          "hint": "Alcopops",
          "items": [
            { "key": "orange", "label": "Orange", "target": 36 },
            { "key": "blue", "label": "Blue", "target": 36 },
            { "key": "apple mango", "label": "Apple and mango", "target": 12 },
            { "key": "tropical", "label": "Tropical", "target": 24 },
            { "key": "ice", "label": "Ice", "target": 24 },
            { "key": "cherry", "label": "Cherry", "target": 12 },
            { "key": "hooch", "label": "Hooch", "target": 18 }
          ]
        },
        {
          "id": "fridgeB",
          "name": "Fridge B (Middle)",
          "hint": "beers",
          "items": [
            { "key": "desperados", "label": "Desperados", "target": 24 },
            { "key": "budweiser", "label": "Budweiser", "target": 24 },
            { "key": "sol", "label": "Sol", "target": 20 },
            { "key": "peroni", "label": "Peroni", "target": 20 },
            { "key": "sanmiguel", "label": "San Miguel", "target": 20 },
            { "key": "oldmtPineapple", "label": "Pineapple and Raspberry", "target": 4 },
            { "key": "oldmtKiwi", "label": "Kiwi and lime", "target": 4 },
            { "key": "oldmtBerries", "label": "Berries n cherries", "target": 4 }
          ]
        },
        {
          "id": "fridgeC",
          "name": "Fridge C (Bottom)",
          "hint": "Alcopops",
          "items": [
            { "key": "orange", "label": "Orange", "target": 30 },
            { "key": "blue", "label": "Blue", "target": 30 },
            { "key": "apple mango", "label": "Apple and mango", "target": 12 },
            { "key": "tropical", "label": "Tropical", "target": 24 },
            { "key": "ice", "label": "Ice", "target": 24 },
            { "key": "cherry", "label": "Cherry", "target": 12 },
            { "key": "blsckcurrant", "label": "Blackcurrant", "target": 18 }
          ]
        }
      ],
      "cleanDown": [
        { "section": "BAR", "tasks": [
          "Bottle condoms on",
          "Glass bin taken out",
          "Waste bin taken out",
          "Place mats and spirit measures in red bucket",
          "Red bucket removed",
          "All sides wiped down"
        ]},
        { "section": "FLOOR", "tasks": [
          "Floors swept",
          "Tables wiped down",
          "Rubbish sorted"
        ]},
        { "section": "RESET BAR", "tasks": [
          "Reset bar"
        ]}
      ]
    }
  ]
};

const LS_SETUP_KEY = "trilogy_close_setup_v1";
const LS_STATE_KEY = "trilogy_close_state_v1";

/** ---------------------------
 *  State
 *  -------------------------- */
let setup = loadSetup();
let state = loadState(); // counts + checklists + selected bar/fridge

function loadSetup(){
  try{
    const raw = localStorage.getItem(LS_SETUP_KEY);
    if(!raw) return structuredClone(DEFAULT_SETUP);
    const parsed = JSON.parse(raw);
    // Backward compat: if user saved the older shape without "bars"
    if(parsed && !parsed.bars && parsed.fridges){
      return {
        venue: parsed.venue || "Trilogy (Cube)",
        bars: [{
          id: "barcadia",
          name: "Barcadia",
          fridges: parsed.fridges,
          cleanDown: structuredClone(DEFAULT_SETUP.bars[0].cleanDown)
        }]
      };
    }
    return parsed;
  }catch(e){
    return structuredClone(DEFAULT_SETUP);
  }
}

function saveSetup(newSetup){
  localStorage.setItem(LS_SETUP_KEY, JSON.stringify(newSetup, null, 2));
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_STATE_KEY);
    if(!raw) return {
      selectedBarId: setup?.bars?.[0]?.id || "barcadia",
      selectedFridgeIndex: 0,
      missingByBar: {},  // { [barId]: { [fridgeId]: { [itemKey]: number } } }
      pickChecked: {},   // { [barId]: { [itemKey]: boolean } }
      cleanChecked: {}   // { [barId]: { [taskId]: boolean } }
    };
    return JSON.parse(raw);
  }catch(e){
    return {
      selectedBarId: setup?.bars?.[0]?.id || "barcadia",
      selectedFridgeIndex: 0,
      missingByBar: {},
      pickChecked: {},
      cleanChecked: {}
    };
  }
}

function saveState(){
  localStorage.setItem(LS_STATE_KEY, JSON.stringify(state));
}

/** ---------------------------
 *  Helpers
 *  -------------------------- */
function byId(id){ return document.getElementById(id); }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function getSelectedBar(){
  return setup.bars.find(b => b.id === state.selectedBarId) || setup.bars[0];
}

function ensureBarBuckets(barId){
  if(!state.missingByBar[barId]) state.missingByBar[barId] = {};
  if(!state.pickChecked[barId]) state.pickChecked[barId] = {};
  if(!state.cleanChecked[barId]) state.cleanChecked[barId] = {};
}

function taskId(section, task){
  return (section + "::" + task).toLowerCase().replace(/\s+/g, "_");
}

function setPillText(){
  byId("appTitle").textContent = "Close Checklist";
  byId("venuePill").textContent = "Venue: " + (setup.venue || "—");
  const bar = getSelectedBar();
  byId("barPill").textContent = "Bar: " + (bar?.name || "—");
}

/** ---------------------------
 *  Render: Bar select
 *  -------------------------- */
function renderBarSelect(){
  const sel = byId("barSelect");
  sel.innerHTML = "";
  setup.bars.forEach(bar => {
    const opt = document.createElement("option");
    opt.value = bar.id;
    opt.textContent = bar.name;
    sel.appendChild(opt);
  });
  sel.value = state.selectedBarId;
  sel.onchange = () => {
    state.selectedBarId = sel.value;
    state.selectedFridgeIndex = 0;
    ensureBarBuckets(state.selectedBarId);
    saveState();
    renderAll();
  };
}

/** ---------------------------
 *  Render: Fridges
 *  -------------------------- */
function renderFridges(){
  const bar = getSelectedBar();
  ensureBarBuckets(bar.id);

  const fridges = bar.fridges || [];
  const idx = clamp(state.selectedFridgeIndex || 0, 0, Math.max(0, fridges.length - 1));
  state.selectedFridgeIndex = idx;

  const current = fridges[idx];

  byId("fridgeTitle").textContent = current ? current.name : "No fridges";
  byId("fridgeHint").textContent = current ? (current.hint || "") : "";
  byId("fridgeCounter").textContent = fridges.length ? `Fridge ${idx + 1} of ${fridges.length}` : "—";

  // Tabs
  const tabs = byId("fridgeTabs");
  tabs.innerHTML = "";
  fridges.forEach((f, i) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "tab" + (i === idx ? " active" : "");
    b.textContent = f.name.replace(/\s*\(.+\)\s*$/, "") || `Fridge ${i+1}`;
    b.onclick = () => {
      state.selectedFridgeIndex = i;
      saveState();
      renderFridges();   // only update fridge area
      renderPickList();  // keep pick list in sync
    };
    tabs.appendChild(b);
  });

  byId("btnPrev").onclick = () => {
    state.selectedFridgeIndex = clamp(idx - 1, 0, fridges.length - 1);
    saveState();
    renderFridges();
    renderPickList();
  };
  byId("btnNext").onclick = () => {
    state.selectedFridgeIndex = clamp(idx + 1, 0, fridges.length - 1);
    saveState();
    renderFridges();
    renderPickList();
  };

  // Table of items
  const table = byId("fridgeTable");
  table.innerHTML = "";

  if(!current){
    table.innerHTML = `<div class="muted">No fridge data found for this bar.</div>`;
    return;
  }

  // IMPORTANT: We do not re-render the entire app on every keystroke.
  // This keeps the iOS keypad stable.
  current.items.forEach(item => {
    const r = document.createElement("div");
    r.className = "row";

    const name = document.createElement("div");
    name.className = "name";
    name.innerHTML = `<div class="label">${escapeHtml(item.label)}</div>
                      <div class="meta">Target: ${item.target}</div>`;

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = "Missing";

    const input = document.createElement("input");
    input.className = "qty";
    input.type = "tel";                 // iOS-friendly keypad stability
    input.inputMode = "numeric";        // numeric keypad
    input.autocomplete = "off";
    input.autocapitalize = "off";
    input.spellcheck = false;
    input.placeholder = "0";
    input.value = getMissing(bar.id, current.id, item.key);

    // Update state on input without triggering full rerender
    input.addEventListener("input", () => {
      const v = parseInt(input.value || "0", 10);
      setMissing(bar.id, current.id, item.key, isNaN(v) ? 0 : clamp(v, 0, 999));
      saveState();
      renderPickList(); // update right panel live
      updateProgressPill();
    });

    r.appendChild(name);
    r.appendChild(badge);
    r.appendChild(input);
    table.appendChild(r);
  });
}

function getMissing(barId, fridgeId, itemKey){
  const b = state.missingByBar[barId] || {};
  const f = b[fridgeId] || {};
  const v = f[itemKey];
  return (typeof v === "number" && !isNaN(v)) ? String(v) : "";
}
function setMissing(barId, fridgeId, itemKey, value){
  ensureBarBuckets(barId);
  if(!state.missingByBar[barId][fridgeId]) state.missingByBar[barId][fridgeId] = {};
  state.missingByBar[barId][fridgeId][itemKey] = value;
}

/** ---------------------------
 *  Render: Pick list
 *  -------------------------- */
function computePickTotalsForBar(bar){
  // total missing per item key across fridges
  ensureBarBuckets(bar.id);
  const totals = {};
  const missing = state.missingByBar[bar.id] || {};

  (bar.fridges || []).forEach(fr => {
    const frMissing = missing[fr.id] || {};
    (fr.items || []).forEach(item => {
      const n = parseInt(frMissing[item.key] || 0, 10) || 0;
      if(n > 0){
        const label = item.label;
        if(!totals[item.key]) totals[item.key] = { key: item.key, label, qty: 0 };
        totals[item.key].qty += n;
      }
    });
  });

  // Sort: largest first, then alpha
  return Object.values(totals).sort((a,b) => (b.qty - a.qty) || a.label.localeCompare(b.label));
}

function renderPickList(){
  const bar = getSelectedBar();
  ensureBarBuckets(bar.id);

  const list = byId("pickList");
  list.innerHTML = "";

  const totals = computePickTotalsForBar(bar);
  const totalDistinct = totals.length;
  const totalQty = totals.reduce((sum, x) => sum + x.qty, 0);

  byId("pickTotals").textContent = `${totalDistinct} items • ${totalQty} total`;
  byId("progressPill").textContent = `Pick list: ${totalDistinct} items`;

  if(totalDistinct === 0){
    list.innerHTML = `<div class="muted">Nothing missing yet. Start entering counts on the left.</div>`;
    return;
  }

  totals.forEach(item => {
    const row = document.createElement("label");
    row.className = "check";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!state.pickChecked[bar.id][item.key];
    cb.addEventListener("change", () => {
      state.pickChecked[bar.id][item.key] = cb.checked;
      saveState();
      updateProgressPill();
    });

    const text = document.createElement("div");
    text.innerHTML = `<div style="font-weight:750;font-size:13px">${escapeHtml(item.label)}</div>
                      <div style="color:var(--muted2);font-size:11px">Total to get</div>`;

    const count = document.createElement("div");
    count.className = "count";
    count.textContent = item.qty;

    row.appendChild(cb);
    row.appendChild(text);
    row.appendChild(count);

    list.appendChild(row);
  });

  byId("btnCheckAllPick").onclick = () => {
    totals.forEach(it => state.pickChecked[bar.id][it.key] = true);
    saveState();
    renderPickList();
    updateProgressPill();
  };
  byId("btnUncheckAllPick").onclick = () => {
    totals.forEach(it => state.pickChecked[bar.id][it.key] = false);
    saveState();
    renderPickList();
    updateProgressPill();
  };
}

function updateProgressPill(){
  const bar = getSelectedBar();
  const totals = computePickTotalsForBar(bar);
  const done = totals.filter(it => !!state.pickChecked[bar.id][it.key]).length;
  byId("progressPill").textContent = `Pick list: ${done}/${totals.length} checked`;
}

/** ---------------------------
 *  Render: Clean down
 *  -------------------------- */
function renderCleanDown(){
  const bar = getSelectedBar();
  ensureBarBuckets(bar.id);

  const list = byId("cleanList");
  list.innerHTML = "";

  const clean = bar.cleanDown || [];
  let allTasks = [];

  clean.forEach(group => {
    const header = document.createElement("div");
    header.className = "muted";
    header.style.marginTop = "4px";
    header.style.marginBottom = "-2px";
    header.style.fontWeight = "750";
    header.textContent = group.section;
    list.appendChild(header);

    (group.tasks || []).forEach(task => {
      const id = taskId(group.section, task);
      allTasks.push(id);

      const row = document.createElement("label");
      row.className = "check";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.cleanChecked[bar.id][id];
      cb.addEventListener("change", () => {
        state.cleanChecked[bar.id][id] = cb.checked;
        saveState();
        updateCleanTotals();
      });

      const text = document.createElement("div");
      text.innerHTML = `<div style="font-weight:750;font-size:13px">${escapeHtml(task)}</div>`;

      const count = document.createElement("div");
      count.className = "count";
      count.textContent = "";

      row.appendChild(cb);
      row.appendChild(text);
      row.appendChild(count);
      list.appendChild(row);
    });
  });

  function updateCleanTotals(){
    const done = allTasks.filter(id => !!state.cleanChecked[bar.id][id]).length;
    byId("cleanTotals").textContent = `${done}/${allTasks.length} done`;
  }
  updateCleanTotals();

  byId("btnCheckAllClean").onclick = () => {
    allTasks.forEach(id => state.cleanChecked[bar.id][id] = true);
    saveState();
    renderCleanDown();
  };
  byId("btnUncheckAllClean").onclick = () => {
    allTasks.forEach(id => state.cleanChecked[bar.id][id] = false);
    saveState();
    renderCleanDown();
  };
}

/** ---------------------------
 *  Reset buttons
 *  -------------------------- */
byId("btnResetInputs").onclick = () => {
  const bar = getSelectedBar();
  ensureBarBuckets(bar.id);
  state.missingByBar[bar.id] = {};
  state.pickChecked[bar.id] = {};
  saveState();
  renderFridges();
  renderPickList();
  updateProgressPill();
};

byId("btnResetChecks").onclick = () => {
  const bar = getSelectedBar();
  ensureBarBuckets(bar.id);
  state.pickChecked[bar.id] = {};
  state.cleanChecked[bar.id] = {};
  saveState();
  renderPickList();
  renderCleanDown();
  updateProgressPill();
};

/** ---------------------------
 *  Setup editor modal
 *  -------------------------- */
const modal = byId("setupModal");
const textarea = byId("setupTextarea");
const err = byId("setupError");

byId("btnEditSetup").onclick = () => {
  textarea.value = JSON.stringify(setup, null, 2);
  err.style.display = "none";
  modal.classList.add("open");
};

byId("btnCancelSetup").onclick = () => modal.classList.remove("open");

byId("btnLoadDefault").onclick = () => {
  textarea.value = JSON.stringify(DEFAULT_SETUP, null, 2);
  err.style.display = "none";
};

byId("btnSaveSetup").onclick = () => {
  try{
    const parsed = JSON.parse(textarea.value);

    // Very light validation
    if(!parsed || typeof parsed !== "object") throw new Error("Setup must be an object.");
    if(!parsed.venue) parsed.venue = "Trilogy (Cube)";
    if(!Array.isArray(parsed.bars)) throw new Error("Setup must include bars: []");

    saveSetup(parsed);
    setup = parsed;

    // Ensure selected bar still exists
    if(!setup.bars.find(b => b.id === state.selectedBarId)){
      state.selectedBarId = setup.bars[0]?.id;
      state.selectedFridgeIndex = 0;
    }
    saveState();

    modal.classList.remove("open");
    renderAll();
  }catch(e){
    err.style.display = "block";
    err.textContent = "Error: " + (e?.message || String(e));
  }
};

// close modal on background tap
modal.addEventListener("click", (e) => {
  if(e.target === modal) modal.classList.remove("open");
});

/** ---------------------------
 *  Disable double-tap zoom (keep pinch zoom)
 *  -------------------------- */
let lastTouchEnd = 0;
document.addEventListener("touchend", function (event) {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    // Prevent double-tap zoom
    event.preventDefault();
  }
  lastTouchEnd = now;
}, { passive: false });

/** ---------------------------
 *  Escape helper
 *  -------------------------- */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/** ---------------------------
 *  Render all
 *  -------------------------- */
function renderAll(){
  setPillText();
  renderBarSelect();
  renderFridges();
  renderPickList();
  renderCleanDown();
  updateProgressPill();
}

ensureBarBuckets(state.selectedBarId);
renderAll();
</script>
</body>
</html>
